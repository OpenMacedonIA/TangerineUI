<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neo Orb AI</title>
    <!-- Socket.IO v4 Client (Local) -->
    <script src="/static/js/socket.io.min.js"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@100;300;500;700&family=JetBrains+Mono:wght@400;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            /* Neo Blue Palette */
            --bg: #050509;
            --orb-core: #00f2ff;
            --orb-glow: rgba(0, 242, 255, 0.6);
            --orb-outer: rgba(0, 119, 255, 0.4);
            --text-main: #e0e0e0;
            --accent: #2de2e6;
            --danger: #ff0055;
            --success: #00ff41;
        }

        body {
            background-color: var(--bg);
            margin: 0;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-family: 'Outfit', sans-serif;
            color: var(--text-main);
        }

        /* --- ORB CONTAINER --- */
        .orb-container {
            position: relative;
            width: 400px;
            height: 400px;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: all 0.5s ease;
        }

        /* The Orb Itself */
        .orb {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, var(--orb-core), var(--orb-outer));
            box-shadow:
                0 0 60px var(--orb-glow),
                inset 0 0 60px rgba(255, 255, 255, 0.4);
            position: relative;
            z-index: 10;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            animation: breathe 4s ease-in-out infinite;
        }

        /* Rings around the orb */
        .ring {
            position: absolute;
            border-radius: 50%;
            border: 2px solid rgba(0, 242, 255, 0.1);
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 20px rgba(0, 242, 255, 0.05);
            pointer-events: none;
        }

        .ring.one {
            width: 280px;
            height: 280px;
            border-top-color: var(--accent);
            animation: spin 10s linear infinite;
        }

        .ring.two {
            width: 340px;
            height: 340px;
            border-bottom-color: var(--accent);
            animation: spin-rev 15s linear infinite;
        }

        .ring.three {
            width: 240px;
            height: 240px;
            border: 1px dashed rgba(255, 255, 255, 0.1);
            animation: spin 20s linear infinite;
        }

        /* --- ANIMATIONS --- */
        @keyframes breathe {

            0%,
            100% {
                transform: scale(1);
                box-shadow: 0 0 60px var(--orb-glow);
            }

            50% {
                transform: scale(1.05);
                box-shadow: 0 0 80px var(--orb-glow);
            }
        }

        @keyframes spin {
            100% {
                transform: translate(-50%, -50%) rotate(360deg);
            }
        }

        @keyframes spin-rev {
            100% {
                transform: translate(-50%, -50%) rotate(-360deg);
            }
        }

        @keyframes pulse-fast {
            0% {
                transform: scale(0.95);
                opacity: 0.8;
            }

            50% {
                transform: scale(1.1);
                opacity: 1;
            }

            100% {
                transform: scale(0.95);
                opacity: 0.8;
            }
        }

        @keyframes vibrate {
            0% {
                transform: translate(0, 0) scale(1.1);
            }

            20% {
                transform: translate(-2px, 2px) scale(1.1);
            }

            40% {
                transform: translate(-2px, -2px) scale(1.1);
            }

            60% {
                transform: translate(2px, 2px) scale(1.1);
            }

            80% {
                transform: translate(2px, -2px) scale(1.1);
            }

            100% {
                transform: translate(0, 0) scale(1.1);
            }
        }

        /* --- STATES --- */
        body.listening .orb {
            transform: scale(1.2);
            background: radial-gradient(circle at 30% 30%, #fff, var(--orb-core));
            box-shadow: 0 0 100px var(--orb-glow);
            animation: pulse-fast 1s infinite;
        }

        body.speaking .orb {
            animation: vibrate 0.3s linear infinite;
            background: radial-gradient(circle at 50% 50%, var(--accent), var(--bg));
            box-shadow: 0 0 40px var(--accent);
        }

        body.thinking .orb {
            animation: spin 1s linear infinite;
            border-radius: 40%;
            /* Morphs slightly */
            background: radial-gradient(circle, #7000ff, #24005e);
            box-shadow: 0 0 60px #7000ff;
        }

        body.user_detected .orb {
            transform: scale(1.1);
        }

        body.sleeping .orb {
            width: 50px;
            height: 50px;
            opacity: 0.3;
            animation: breathe 8s infinite;
            filter: grayscale(1);
        }

        body.sleeping .ring {
            opacity: 0;
        }

        /* --- STATUS BAR --- */
        .status-bar {
            position: absolute;
            bottom: 0;
            width: 100%;
            padding: 15px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(to top, rgba(0, 0, 0, 0.8), transparent);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9rem;
            box-sizing: border-box;
            z-index: 100;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 10px;
            opacity: 0.7;
        }

        .status-item i {
            color: var(--accent);
        }

        .transcript-box {
            position: absolute;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            width: 60%;
            text-align: center;
            font-size: 1.5rem;
            font-weight: 300;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.8);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .transcript-box.visible {
            opacity: 1;
        }

        /* --- LIVE TERMINAL (Mini) --- */
        .terminal-mini {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 300px;
            height: 150px;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 10px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.7rem;
            color: #00ff41;
            overflow: hidden;
            display: flex;
            flex-direction: column-reverse;
            /* Bottom up */
        }

        .log-line {
            margin: 2px 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* --- SPLIT VIEW (Content) --- */
        .content-overlay {
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
            background: var(--bg);
            z-index: 200;
            display: none;
            flex-direction: column;
            padding: 20px;
        }

        body.split-view .content-overlay {
            display: flex;
        }

        body.split-view .orb-container {
            transform: scale(0.3);
            position: absolute;
            bottom: 20px;
            right: 20px;
            z-index: 210;
        }
    </style>
</head>

<body class="idle">

    <!-- Mini Terminal -->
    <div class="terminal-mini" id="mini-term">
        <div class="log-line">> System Ready...</div>
    </div>

    <!-- Orb -->
    <div class="orb-container">
        <div class="ring one"></div>
        <div class="ring two"></div>
        <div class="ring three"></div>
        <div class="orb" id="neo-orb"></div>
    </div>

    <!-- Transcript -->
    <div class="transcript-box" id="transcript"></div>

    <!-- Status Bar -->
    <div class="status-bar">
        <div class="status-item">
            <i class="fas fa-microchip"></i>
            <span id="cpu-load">CPU: 12%</span>
        </div>
        <div class="status-item" style="flex-grow: 1; justify-content: center;">
            <span id="system-status">NEO CORE ONLINE</span>
        </div>
        <div class="status-item">
            <i class="fas fa-clock"></i>
            <span id="clock">12:00</span>
        </div>
    </div>

    <!-- Content Overlay -->
    <div class="content-overlay" id="content-area">
        <button onclick="closeContent()" style="position:absolute; top:20px; right:20px; z-index:220;"
            class="btn btn-sm btn-outline-light">X</button>
        <iframe id="visual-frame" style="flex:1; border:none; border-radius:10px;" src=""></iframe>
        <img id="visual-img" style="flex:1; object-fit:contain; display:none;" src="">
    </div>

    <script>
        const socket = io({ transports: ['polling'] });

        const body = document.body;
        const orb = document.getElementById('neo-orb');
        const transcript = document.getElementById('transcript');
        const statusText = document.getElementById('system-status');
        const term = document.getElementById('mini-term');

        // --- CLOCK ---
        setInterval(() => {
            const now = new Date();
            document.getElementById('clock').innerText = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }, 1000);

        // --- SOCKET EVENTS ---
        socket.on('connect', () => {
            log("Connected to Core");
            statusText.innerText = "ONLINE";
        });

        socket.on('disconnect', () => {
            log("Connection Lost");
            statusText.innerText = "OFFLINE";
            body.className = 'sleeping';
        });

        socket.on('face_update', (data) => {
            // State Update
            if (data.state) {
                body.className = data.state;
                statusText.innerText = data.state.toUpperCase().replace('_', ' ');

                // Specific text behaviors
                if (data.state === 'listening') transcript.innerText = "Escuchando...";
                if (data.state === 'thinking') transcript.innerText = "Procesando...";

                transcript.classList.toggle('visible', ['listening', 'thinking', 'speaking'].includes(data.state));
            }
            // Context/Data Update
            if (data.data && data.data.text) {
                // If STT text comes in
                transcript.innerText = `"${data.data.text}"`;
                transcript.classList.add('visible');
            }
        });

        socket.on('stt:partial', (text) => {
            transcript.innerText = text;
            transcript.classList.add('visible');
            body.className = 'listening';
        });

        socket.on('stt:final', (text) => {
            transcript.innerText = text;
            log("User: " + text);
        });

        socket.on('tts:start', (text) => {
            transcript.innerText = text;
            body.className = 'speaking';
            log("Neo: " + text);
        });

        socket.on('tts:end', () => {
            body.className = 'idle';
            transcript.classList.remove('visible');
        });

        // --- CONTENT HANDLING ---
        socket.on('visual:show', (data) => {
            log("Visual: " + data.type);
            showContent(data.url, data.type);
        });

        socket.on('visual:close', closeModal);

        function showContent(url, type) {
            body.classList.add('split-view');
            const frame = document.getElementById('visual-frame');
            const img = document.getElementById('visual-img');

            if (type === 'image') {
                frame.style.display = 'none';
                img.style.display = 'block';
                img.src = url;
            } else {
                img.style.display = 'none';
                frame.style.display = 'block';
                frame.src = url;
            }
        }

        function closeModal() {
            body.classList.remove('split-view');
            setTimeout(() => {
                document.getElementById('visual-frame').src = '';
                document.getElementById('visual-img').src = '';
            }, 500);
        }

        // --- UTILS ---
        function log(msg) {
            const line = document.createElement('div');
            line.className = 'log-line';
            line.innerText = `> ${msg}`;
            term.prepend(line);
            if (term.children.length > 10) term.lastChild.remove();
        }

        // Fake CPU Update
        setInterval(() => {
            const load = Math.floor(Math.random() * 20) + 5;
            document.getElementById('cpu-load').innerText = `CPU: ${load}%`;
        }, 2000);

    </script>
</body>

</html>